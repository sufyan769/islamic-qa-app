<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>نظام الأسئلة الإسلامية</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; direction: rtl; }
    input, button { font-size: 1rem; padding: 5px; }
    .result { background: white; margin: 10px 0; padding: 10px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .question-link { font-size: 0.9em; color: #007bff; text-decoration: underline; cursor: pointer; }
  </style>
</head>
<body>
  <h1>ابحث في كتب الإسلام</h1>
  <form id="searchForm">
    <input type="text" id="query" placeholder="اكتب سؤالك..." size="40" required />
    <button type="submit">بحث</button>
  </form>

  <div id="results"></div>

  <hr/>
  <h3>أسئلة مقترحة:</h3>
  <ul id="previous-questions"></ul>

  <script>
    const form = document.getElementById("searchForm");
    const resultsDiv = document.getElementById("results");
    const prevQuestions = document.getElementById("previous-questions");

    fetch("/ask?q=كلمة&mode=ai_only")
      .then(r => r.json())
      .then(data => {
        if (data.previous_questions) {
          data.previous_questions.forEach(q => {
            const li = document.createElement("li");
            li.innerHTML = `<span class="question-link" onclick="document.getElementById('query').value='${q}'; form.requestSubmit();">${q}</span>`;
            prevQuestions.appendChild(li);
          });
        }
      });

    form.addEventListener("submit", e => {
      e.preventDefault();
      resultsDiv.innerHTML = "جاري البحث...";
      const q = document.getElementById("query").value;
      fetch(`/ask?q=${encodeURIComponent(q)}&mode=default`)
        .then(r => r.json())
        .then(data => {
          resultsDiv.innerHTML = "";
          if (data.claude_answer) {
            const a = document.createElement("div");
            a.innerHTML = `<h3>الجواب:</h3><p>${data.claude_answer}</p>`;
            resultsDiv.appendChild(a);
          }
          if (data.sources_retrieved) {
            data.sources_retrieved.forEach(item => {
              const d = document.createElement("div");
              d.className = "result";
              d.innerHTML = `
                <b>الكتاب:</b> ${item.book_title}<br>
                <b>المؤلف:</b> ${item.author_name}<br>
                <b>الجزء:</b> ${item.part_number} - <b>الصفحة:</b> ${item.page_number}<br>
                <b>النص:</b> ${item.text_content}<br>
                <a href="/view/${item.id}" target="_blank">رابط دائم</a>
              `;
              resultsDiv.appendChild(d);
            });
          }
        });
    });
  </script>
</body>
</html>
