<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نظام البحث في الكتب الإسلامية</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans p-6">
  <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6">
    <h1 class="text-2xl font-bold text-indigo-700 text-center mb-6">نظام البحث في الكتب الإسلامية</h1>

    <!-- واجهة إدخال البحث -->
    <div class="flex flex-col sm:flex-row gap-4 mb-4">
      <input id="searchInput" type="text" placeholder="اكتب سؤالك أو عبارتك..." class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">
      <button onclick="runSearch('default')" class="bg-indigo-600 text-white px-5 py-3 rounded-lg hover:bg-indigo-700">بحث</button>
    </div>

    <!-- أزرار أنماط البحث -->
    <div class="flex flex-wrap gap-3 justify-center mb-6">
      <button onclick="runSearch('default')" class="px-4 py-2 bg-indigo-100 text-indigo-800 rounded-md font-semibold">بحث مختصر (ذكاء + 7 نتائج)</button>
      <button onclick="runSearch('ai_only')" class="px-4 py-2 bg-yellow-100 text-yellow-800 rounded-md font-semibold">ذكاء فقط</button>
      <button onclick="runSearch('full')" class="px-4 py-2 bg-green-100 text-green-800 rounded-md font-semibold">البحث الشامل في الكتب</button>
    </div>

    <!-- أنميشن التحميل -->
    <div id="loadingSpinner" class="text-center hidden">
      <div class="flex justify-center items-center">
        <svg class="animate-spin h-6 w-6 text-indigo-600 mr-2" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" />
        </svg>
        <span class="text-gray-700">جاري البحث في الكتب...</span>
      </div>
    </div>

    <!-- منطقة عرض النتائج -->
    <div id="resultsArea" class="space-y-4">
      <!-- الذكاء الاصطناعي -->
      <div id="aiAnswer" class="bg-yellow-50 border border-yellow-300 p-4 rounded-md hidden"></div>
      <!-- المصادر -->
      <div id="sourcesList" class="space-y-3"></div>
      <!-- زر تحميل المزيد -->
      <div id="loadMoreContainer" class="text-center hidden">
        <button onclick="loadMore()" class="mt-4 bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">تحميل المزيد</button>
      </div>
    </div>
  </div>

<script>
let currentMode = 'default';
let lastQuery = '';
let from = 0;
const size = 20;
const API_BASE = 'https://islamic-qa-api-backend.onrender.com';

function showLoading(show) {
  const loader = document.getElementById('loadingSpinner');
  if (show) loader.classList.remove('hidden');
  else loader.classList.add('hidden');
}

function runSearch(mode) {
  const query = document.getElementById('searchInput').value.trim();
  if (!query) return;

  currentMode = mode;
  lastQuery = query;
  from = 0;

  document.getElementById('aiAnswer').classList.add('hidden');
  document.getElementById('sourcesList').innerHTML = '';
  document.getElementById('loadMoreContainer').classList.add('hidden');

  showLoading(true);
  fetchResults();
}

function fetchResults() {
  let url = `${API_BASE}/ask?q=${encodeURIComponent(lastQuery)}&from=${from}&size=${size}&mode=${currentMode}`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      showLoading(false);
      if (currentMode !== 'full' && data.claude_answer) {
        const aiDiv = document.getElementById('aiAnswer');
        aiDiv.textContent = data.claude_answer;
        aiDiv.classList.remove('hidden');
      }

      if (currentMode !== 'ai_only') {
        const list = document.getElementById('sourcesList');
        if (data.sources_retrieved) {
          data.sources_retrieved.forEach(src => {
            const item = document.createElement('div');
            item.className = 'bg-gray-50 border p-3 rounded';
            item.innerHTML = `<strong>${src.book_title}</strong> - ${src.author_name}<br><span class='text-sm text-gray-600'>${highlight(src.text_content, lastQuery, 200)} <a class='text-blue-600 underline cursor-pointer' onclick='alertFullText(${JSON.stringify(src.text_content)})'>عرض النص كاملًا</a></span>`;
            list.appendChild(item);
          });
        }
      }

      if (currentMode === 'full' && data.sources_retrieved.length === size) {
        document.getElementById('loadMoreContainer').classList.remove('hidden');
      }
    })
    .catch(err => {
      showLoading(false);
      console.error('Fetch error:', err);
    });
}

function loadMore() {
  from += size;
  fetchResults();
}

function alertFullText(text) {
  alert(text);
}

function highlight(text, query, maxLen = 200) {
  const words = query.split(/\s+/).filter(Boolean);
  let result = text.substring(0, maxLen);
  for (let word of words) {
    result = result.replace(new RegExp(word, 'gi'), match => `<mark class='bg-yellow-200'>${match}</mark>`);
  }
  return result;
}

// دعم زر Enter
document.getElementById('searchInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') runSearch('default');
});
</script>
</body>
</html>
