# app.py â€“ Ø¨Ø¹Ø¯ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­Ø³ÙŠÙ† 1 Ùˆ 2 + ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
from flask import Flask, request, jsonify
from flask_cors import CORS
from elasticsearch import Elasticsearch
from elasticsearch.exceptions import ConnectionError, AuthenticationException
from anthropic import Anthropic
import os, sys, re, json

app = Flask(__name__)
CORS(app)

CLOUD_ID = os.environ.get("CLOUD_ID")
ELASTIC_USERNAME = os.environ.get("ELASTIC_USERNAME")
ELASTIC_PASSWORD = os.environ.get("ELASTIC_PASSWORD")
INDEX_NAME = "islamic_texts"

CLAUDE_KEY = os.environ.get("ANTHROPIC_API_KEY")
claude_client = Anthropic(api_key=CLAUDE_KEY) if CLAUDE_KEY else None

AR_STOPWORDS = {"Ù…Ù†", "ÙÙŠ", "Ø¹Ù„Ù‰", "Ø¥Ù„Ù‰", "Ø¹Ù†", "Ù…Ø§", "Ø¥Ø°", "Ø£Ùˆ", "Ùˆ", "Ø«Ù…", "Ø£Ù†", "Ø¥Ù†", "ÙƒØ§Ù†", "Ù‚Ø¯", "Ù„Ù…", "Ù„Ù†", "Ù„Ø§", "Ù‡Ø°Ù‡", "Ù‡Ø°Ø§", "Ø°Ù„Ùƒ", "Ø§Ù„Ø°ÙŠ", "Ø§Ù„ØªÙŠ", "Ø§Ù„"}

es = None
try:
    if CLOUD_ID and ELASTIC_USERNAME and ELASTIC_PASSWORD:
        es = Elasticsearch(cloud_id=CLOUD_ID, basic_auth=(ELASTIC_USERNAME, ELASTIC_PASSWORD))
        if not es.ping():
            raise ValueError("Elastic unreachable")
    else:
        raise ValueError("Elastic env vars missing")
except Exception as e:
    print("Elastic error:", e)
    sys.exit(1)

# ğŸŸ¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (ØªØ­Ø³ÙŠÙ† Ù„Ù…Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø¨Ø­Ø«)
PREVIOUS_QUESTIONS = [
    "Ù…Ø§ Ø­ÙƒÙ… Ø´Ø¯ Ø§Ù„Ø±Ø­Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø¨ÙˆØ±ØŸ",
    "Ù‡Ù„ Ø²ÙŠØ§Ø±Ø© Ù‚Ø¨Ø± Ø§Ù„Ù†Ø¨ÙŠ Ù…Ø´Ø±ÙˆØ¹Ø©ØŸ",
    "Ù…Ø§ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ù‚Ø¨Ø± ÙˆØ§Ù„Ø¶Ø±ÙŠØ­ØŸ",
    "Ù‡Ù„ ÙŠØ¬ÙˆØ² Ø§Ù„ØªÙˆØ³Ù„ Ø¨Ø§Ù„Ø£Ù…ÙˆØ§ØªØŸ",
    "Ù…Ø§ Ø­ÙƒÙ… Ø§Ù„Ù…ÙˆÙ„Ø¯ Ø§Ù„Ù†Ø¨ÙˆÙŠØŸ",
    "Ø£Ø¯Ù„Ø© ØªØ­Ø±ÙŠÙ… Ø§Ù„Ø³Ø­Ø± ÙÙŠ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…",
    "Ù…Ù† Ù‡ÙŠ Ø£Ø³Ù…Ø§Ø¡ Ø¨Ù†Øª Ø¹Ù…ÙŠØ³ØŸ"
]

@app.route("/ask")
def ask():
    query = request.args.get("q", "").strip()
    mode = request.args.get("mode", "default")
    frm = int(request.args.get("from", 0))
    size = int(request.args.get("size", 20))

    if not query:
        return jsonify({"error": "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³ØªØ¹Ù„Ø§Ù…."}), 400

    should = [
        {"match_phrase": {"text_content": {"query": query, "boost": 100}}}
    ]

    es_query = {"bool": {"should": should, "minimum_should_match": 1}}

    sources = []
    try:
        if mode != "ai_only":
            res = es.search(index=INDEX_NAME, body={"query": es_query, "from": frm, "size": size, "sort": ["_score"]})
            for hit in res["hits"]["hits"]:
                doc = hit["_source"]
                sources.append({
                    "book_title": doc.get("book_title", ""),
                    "author_name": doc.get("author_name", ""),
                    "part_number": doc.get("part_number", ""),
                    "page_number": doc.get("page_number", ""),
                    "text_content": doc.get("text_content", ""),
                    "score": hit.get("_score", 0),
                    "id": hit.get("_id", "")  # Ù„Ø±Ø§Ø¨Ø· Ø¯Ø§Ø¦Ù…
                })
    except Exception as e:
        return jsonify({"error": f"Search failure: {e}"}), 500

    claude_answer = ""
    if mode in ("default", "ai_only") and claude_client:
        context = "\n\n".join([
            f"Ø§Ù„ÙƒØªØ§Ø¨: {s['book_title']}\nØ§Ù„Ù…Ø¤Ù„Ù: {s['author_name']}\nØ§Ù„Ø¬Ø²Ø¡: {s['part_number']}\nØ§Ù„ØµÙØ­Ø©: {s['page_number']}\nØ§Ù„Ù†Øµ: {s['text_content']}" for s in sources
        ])
        prompt = f"Ø£Ø¬Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù† Ø§Ù„Ø³Ø¤Ø§Ù„:\n{query}\n" + (f"Ø§Ø³ØªÙ†Ø§Ø¯Ù‹Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ØªØ§Ù„ÙŠØ©:\n{context}" if context else "")
        try:
            msg = claude_client.messages.create(model="claude-3-5-sonnet-20241022", max_tokens=800, messages=[{"role": "user", "content": prompt}])
            claude_answer = msg.content[0].text.strip()
        except Exception as e:
            claude_answer = f"Claude error: {e}"

    return jsonify({
        "claude_answer": claude_answer if mode != "full" else "",
        "sources_retrieved": [] if mode == "ai_only" else sources,
        "previous_questions": PREVIOUS_QUESTIONS
    })

if __name__ == "__main__":
    app.run(debug=True, host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))
