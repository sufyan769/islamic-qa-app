<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>البحث في كتب الإسلام</title>

  <!-- تحذير Tailwind خاص بالإنتاج فقط، يمكن تجاهله أثناء التطوير -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style> mark{background:#fef08a;font-weight:bold} </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-3xl mx-auto py-10 px-4">
    <h1 class="text-2xl font-bold mb-4">البحث في كتب الإسلام</h1>

    <input id="query" type="text" placeholder="اكتب سؤالك هنا..." class="w-full border p-3 rounded mb-2"
           onkeydown="if(event.key==='Enter') runSearch()">
    <button onclick="runSearch()" class="bg-blue-600 text-white px-4 py-2 rounded mb-4">اسأل</button>

    <div id="resultCount" class="mb-4 font-semibold"></div>
    <div id="results"></div>

    <div class="text-center mt-6">
      <button id="loadMoreBtn" onclick="loadMore()" class="hidden bg-gray-700 text-white px-4 py-2 rounded">
        تحميل المزيد
      </button>
    </div>
  </div>

  <script>
    const apiBase = 'https://islamic-qa-api-backend.onrender.com'; // العنوان الصحيح
    const pageSize = 20;
    let fromIndex = 0;
    let lastQuery = '';

    function highlight(txt, terms) {
      terms.forEach(t => {
        const re = new RegExp('(' + t.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&') + ')', 'gi');
        txt = txt.replace(re, '<mark>$1</mark>');
      });
      return txt;
    }

    function runSearch() {
      fromIndex = 0;
      const q = document.getElementById('query').value.trim();
      if (!q) return;
      lastQuery = q;
      document.getElementById('results').innerHTML = '...جاري البحث';
      fetchResults(q, true);
    }

    function loadMore() { fetchResults(lastQuery, false); }

    function fetchResults(q, clear) {
      fetch(`${apiBase}/ask?q=${encodeURIComponent(q)}&from=${fromIndex}&size=${pageSize}`)
        .then(r => r.json())
        .then(data => {
          if (clear) document.getElementById('results').innerHTML = '';
          document.getElementById('resultCount').textContent =
            data.total_results ? `عدد النتائج: ${data.total_results}` : '';

          if (Array.isArray(data.sources_retrieved) && data.sources_retrieved.length) {
            const terms = q.split(/\s+/);
            data.sources_retrieved.forEach(src => {
              const short = src.text_content.split(' ').slice(0, 30).join(' ') + '...';
              const full = highlight(src.text_content, terms);
              const id = 'res-' + fromIndex;

              document.getElementById('results').insertAdjacentHTML('beforeend', `
                <div class="bg-white rounded shadow p-4 mb-4">
                  <div class="font-bold mb-1">${src.book_title} – ${src.author_name}</div>
                  <div class="text-sm mb-1 text-gray-500">جزء ${src.part_number}، صفحة ${src.page_number}</div>
                  <div id="${id}">
                    ${highlight(short, terms)}
                    <button class="text-blue-600 underline text-sm" onclick="
                      this.previousSibling.remove(); this.remove();
                      document.getElementById('${id}').innerHTML='${full.replace(/'/g,'&#39;')}';
                    ">عرض النص الكامل</button>
                  </div>
                </div>`
              );
              fromIndex++;
            });
            document.getElementById('loadMoreBtn').classList.remove('hidden');
          } else if (clear) {
            document.getElementById('results').textContent = 'لا توجد نتائج.';
            document.getElementById('loadMoreBtn').classList.add('hidden');
          }
        })
        .catch(e => alert('خطأ في الاتصال بالخادم'));
    }
  </script>
</body>
</html>
