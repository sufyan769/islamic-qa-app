<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام البحث في الكتب الإسلامية</title>
  <style>
    body { font-family: sans-serif; background: #f9f9f9; padding: 20px; color: #333; }
    input, button { font-size: 1.2em; padding: 10px; margin: 10px 0; width: 100%; }
    .result, .ai-answer { background: #fff; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 0 5px #ccc; }
    .more { color: blue; cursor: pointer; display: inline-block; margin-top: 10px; }
    .hidden { display: none; }
    #progress-bar { width: 0%; height: 5px; background: green; transition: width 0.5s; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h1>البحث في الكتب الإسلامية</h1>
  <input type="text" id="query" placeholder="اكتب سؤالك..." onkeydown="if(event.key==='Enter') search()">
  <button onclick="search()">ابحث</button>
  <div id="progress-container"><div id="progress-bar"></div></div>
  <div id="claude" class="ai-answer"></div>
  <div id="gemini" class="ai-answer"></div>
  <div id="results"></div>

<script>
function search() {
  const q = document.getElementById('query').value.trim();
  if (!q) return;
  document.getElementById('results').innerHTML = "";
  document.getElementById('claude').textContent = "";
  document.getElementById('gemini').textContent = "";
  updateProgress(0);
  simulateProgress();

  fetch("https://islamic-qa-api-backend.onrender.com/ask?q=" + encodeURIComponent(q) + "&mode=default")
    .then(res => res.json())
    .then(data => {
      updateProgress(100);
      if (data.claude_answer)
        document.getElementById('claude').innerHTML = `<b>Claude:</b><br>${data.claude_answer}`;

      if (data.gemini_answer && !data.gemini_answer.includes('error'))
        document.getElementById('gemini').innerHTML = `<b>Gemini:</b><br>${data.gemini_answer}`;
      else
        document.getElementById('gemini').innerHTML = `<b>Gemini:</b> <span class='error'>تعذر الحصول على إجابة من Gemini</span>`;

      if (data.sources_retrieved) {
        const html = data.sources_retrieved.map(doc => {
          const full = doc.text_content;
          const short = full.length > 300 ? full.slice(0, 300) + "..." : full;
          const id = Math.random().toString(36).substring(7);
          return `<div class='result'>
            <b>${doc.book_title}</b> - ${doc.author_name} <br>
            <div id='short-${id}'>${short} <span class='more' onclick="showFull('${id}', \`${full.replace(/`/g, '\\`')}\`)">عرض المزيد</span></div>
          </div>`;
        }).join('');
        document.getElementById('results').innerHTML = html;
      }
    })
    .catch(err => {
      updateProgress(100);
      document.getElementById('results').innerHTML = "<p class='error'>تعذّر تحميل النتائج: تحقق من الاتصال أو من صحة الرابط</p>";
    });
}

function showFull(id, fullText) {
  document.getElementById('short-' + id).innerHTML = fullText;
}

function updateProgress(val) {
  document.getElementById('progress-bar').style.width = val + '%';
}

function simulateProgress() {
  let val = 0;
  const interval = setInterval(() => {
    if (val < 90) {
      val += 10;
      updateProgress(val);
    } else {
      clearInterval(interval);
    }
  }, 300);
}
</script>
</body>
</html>
