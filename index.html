<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø£Ø¬ÙˆØ¨Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ</title>
    <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8FAFC; /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© ÙˆÙ†Ø¸ÙŠÙØ© */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            font-size: 1.1rem;
            color: #1E293B; /* Ù„ÙˆÙ† Ù†Øµ Ø¯Ø§ÙƒÙ† */
        }
        .container {
            background-color: #ffffff;
            border-radius: 16px; /* Ø²ÙˆØ§ÙŠØ§ Ø£ÙƒØ«Ø± Ø§Ø³ØªØ¯Ø§Ø±Ø© */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); /* Ø¸Ù„ Ø£ÙƒØ¨Ø± ÙˆØ£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ù‹Ø§ */
            padding: 40px;
            max-width: 950px; /* Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        .input-section {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .input-field {
            flex: 1 1 45%; /* ØªÙˆØ²ÙŠØ¹ Ù…Ø±Ù† Ù„Ù„Ø­Ù‚ÙˆÙ„ */
            min-width: 280px;
        }
        #questionInput, #authorInput {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid #CBD5E1; /* Ù„ÙˆÙ† Ø­Ø¯ÙˆØ¯ Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ */
            border-radius: 10px; /* Ø²ÙˆØ§ÙŠØ§ Ù…Ø³ØªØ¯ÙŠØ±Ø© Ø£ÙƒØ«Ø± */
            font-size: 1.1rem;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            color: #1E293B;
            background-color: #F8FAFC; /* Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        }
        #questionInput:focus, #authorInput:focus {
            border-color: #4338CA; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ø¯Ø§ÙƒÙ† Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² */
            box-shadow: 0 0 0 3px rgba(67, 56, 202, 0.2); /* Ø¸Ù„ Ø®ÙÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² */
        }
        #askButton {
            background-color: #4338CA; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ø¯Ø§ÙƒÙ† Ù„Ù„Ø²Ø± */
            color: white;
            padding: 14px 25px;
            border-radius: 10px;
            font-size: 1.15rem; /* Ø­Ø¬Ù… Ø®Ø· Ø£ÙƒØ¨Ø± Ù„Ù„Ø²Ø± */
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(67, 56, 202, 0.3); /* Ø¸Ù„ Ù„Ù„Ø²Ø± */
        }
        #askButton:hover {
            background-color: #3730A3; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ø£ØºÙ…Ù‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ… */
            transform: translateY(-2px); /* ØªØ£Ø«ÙŠØ± Ø±ÙØ¹ Ø®ÙÙŠÙ */
            box-shadow: 0 6px 15px rgba(67, 56, 202, 0.4);
        }
        #askButton:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(67, 56, 202, 0.2);
        }
        #responseArea {
            background-color: #FDFDFE; /* Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ Ù†Ø§ØµØ¹Ø© Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© */
            border: 1px solid #E2E8F0; /* Ø­Ø¯ÙˆØ¯ Ø±Ù…Ø§Ø¯ÙŠØ© Ù†Ø§Ø¹Ù…Ø© */
            border-radius: 12px;
            padding: 25px;
            min-height: 200px;
            font-size: 1.1rem;
            color: #334155; /* Ù„ÙˆÙ† Ù†Øµ Ø±Ù…Ø§Ø¯ÙŠ Ø£ØºÙ…Ù‚ */
            line-height: 1.7;
            overflow-y: auto;
            max-height: 650px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05); /* Ø¸Ù„ Ø¯Ø§Ø®Ù„ÙŠ Ø®ÙÙŠÙ */
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #4338CA; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ù„Ù„Ø³Ø¨ÙŠÙ†Ø± */
            border-radius: 50%;
            width: 30px; /* Ø³Ø¨ÙŠÙ†Ø± Ø£ÙƒØ¨Ø± */
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto; /* Ù…Ø³Ø§ÙØ© Ø£ÙƒØ¨Ø± */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #EF4444; /* Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ø³Ø§Ø·Ø¹ Ù„Ù„Ø®Ø·Ø£ */
            font-weight: 700;
            text-align: center;
            padding: 10px;
            background-color: #FEF2F2; /* Ø®Ù„ÙÙŠØ© Ø­Ù…Ø±Ø§Ø¡ ÙØ§ØªØ­Ø© Ù„Ù„Ø®Ø·Ø£ */
            border-radius: 8px;
        }
        .answer-section h2 {
            font-size: 1.6rem; /* Ø®Ø· Ø£ÙƒØ¨Ø± Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
            font-weight: 700;
            color: #4338CA; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ø¯Ø§ÙƒÙ† Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
            margin-bottom: 15px;
            border-bottom: 2px solid #E0E7FF; /* Ø®Ø· Ø³ÙÙ„ÙŠ Ø®ÙÙŠÙ */
            padding-bottom: 8px;
        }
        .answer-section p {
            margin-bottom: 15px;
            color: #334155;
        }
        .author-group {
            background-color: #F0F4F8; /* Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ Ù…Ø²Ø±Ù‚ ÙØ§ØªØ­ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© */
            border: 1px solid #CBD5E1;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        .author-group-header {
            font-weight: 700;
            margin-bottom: 12px;
            color: #1E293B;
            font-size: 1.4rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .author-group-header:hover {
            text-decoration: underline;
        }
        .source-item {
            border-top: 1px dashed #D1D5DB; /* Ø®Ø· ÙØ§ØµÙ„ Ø±Ù…Ø§Ø¯ÙŠ */
            padding-top: 15px;
            margin-top: 15px;
        }
        .source-item:first-child {
            border-top: none;
            padding-top: 0;
            margin-top: 0;
        }
        .source-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: #4338CA;
            font-size: 1.2rem;
        }
        .source-meta {
            font-size: 0.95rem;
            color: #64748B; /* Ù„ÙˆÙ† Ø±Ù…Ø§Ø¯ÙŠ Ø£Ø²Ø±Ù‚ */
            margin-bottom: 12px;
        }
        .source-text-truncated {
            font-size: 1rem;
            color: #334155;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        .toggle-text-button {
            color: #4338CA;
            cursor: pointer;
            text-decoration: underline;
            font-weight: 600;
            margin-top: 8px;
            display: inline-block;
            font-size: 0.95rem;
        }
        .toggle-text-button:hover {
            color: #3730A3;
        }
        .show-all-author-sources-button {
            background-color: #E0E7FF; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹ */
            color: #4338CA;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            display: block;
            width: fit-content;
            margin: 20px auto 0; /* ØªÙˆØ³ÙŠØ· Ø§Ù„Ø²Ø± */
            text-decoration: none;
        }
        .show-all-author-sources-button:hover {
            background-color: #C7D2FE;
        }
        /* Ù†Ù…Ø· Ù„Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø© ÙÙŠ Ø§Ù„Ù†Øµ */
        .highlight {
            background-color: #FDE68A; /* Ù„ÙˆÙ† Ø£ØµÙØ± Ø°Ù‡Ø¨ÙŠ Ù„Ù„ØªÙ…ÙŠÙŠØ² */
            color: #92400E;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 4px;
        }
        /* Ù‚Ø³Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© */
        #popularQuestionsSection {
            background-color: #F0F4F8; /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© Ù„Ù„Ù‚Ø³Ù… */
            border: 1px solid #CBD5E1;
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        #popularQuestionsSection h2 {
            font-size: 1.8rem; /* Ø®Ø· Ø£ÙƒØ¨Ø± Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
            font-weight: 700;
            color: #4338CA;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid #E0E7FF;
            padding-bottom: 10px;
        }
        #popularQuestionsList {
            list-style: none;
            padding: 0;
            display: grid; /* Ø§Ø³ØªØ®Ø¯Ø§Ù… grid Ù„ØªØ®Ø·ÙŠØ· Ø£ÙØ¶Ù„ */
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Ø£Ø¹Ù…Ø¯Ø© Ù…Ø±Ù†Ø© */
            gap: 12px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± */
        }
        #popularQuestionsList li {
            background-color: #ffffff;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            color: #334155;
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        #popularQuestionsList li:hover {
            background-color: #F0F4F8;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        #popularQuestionsList li::before {
            content: "ğŸ’¡"; /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø®ÙÙŠÙØ© */
            margin-right: 10px;
            font-size: 1.2rem;
        }
        .hidden {
            display: none !important;
        }
    </style>
    <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase SDKs Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø± (Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙˆØ§ÙÙ‚Ø©) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl font-bold text-center text-indigo-700 mb-6">Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø£Ø¬ÙˆØ¨Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ</h1>
        <div class="input-section">
            <div class="input-field">
                <input type="text" id="questionInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§...">
            </div>
            <div class="input-field">
                <input type="text" id="authorInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)...">
            </div>
            <button id="askButton">Ø§Ø³Ø£Ù„</button>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© (ÙŠØ¸Ù‡Ø± Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§) -->
        <div id="popularQuestionsSection">
            <h2>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</h2>
            <ul id="popularQuestionsList">
                <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                <p class="text-center text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...</p>
            </ul>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (ØªØ®ØªÙÙŠ Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§) -->
        <div id="responseArea" class="response-area hidden">
            <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
            <div id="loadingMessage" class="hidden">
                <div class="loading-spinner"></div>
                <p class="text-center text-gray-500 mt-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ØµØ§Ø¯Ø± ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª...</p>
            </div>

            <!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Gemini) -->
            <div id="geminiAnswerContent" class="answer-section mb-4"></div>
            
            <!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Claude) -->
            <div id="claudeAnswerContent" class="answer-section mb-4"></div>
            
            <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØµØ§Ø¯Ø± -->
            <h2 id="sourcesHeader" class="text-xl font-semibold text-indigo-700 mb-4 hidden"></h2>
            
            <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…ØµØ§Ø¯Ø± -->
            <div id="sourcesContainer">
                <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ù‡Ù†Ø§ -->
            </div>
            
            <!-- Ø±Ø³Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù†ØªØ§Ø¦Ø¬ -->
            <p id="noResultsMessage" class="text-gray-500 text-center hidden">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£Ø¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø°Ø§Øª ØµÙ„Ø© ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø©.</p>
        </div>
    </div>

    <script>
        console.log("Script started loading."); 
        
        document.addEventListener('DOMContentLoaded', (event) => {
            console.log("DOMContentLoaded event fired."); 
            const questionInput = document.getElementById('questionInput');
            const authorInput = document.getElementById('authorInput');
            const askButton = document.getElementById('askButton');
            console.log("askButton element:", askButton); 

            const responseArea = document.getElementById('responseArea');
            const popularQuestionsSection = document.getElementById('popularQuestionsSection'); // Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const popularQuestionsList = document.getElementById('popularQuestionsList');
            const geminiAnswerContent = document.getElementById('geminiAnswerContent');
            const claudeAnswerContent = document.getElementById('claudeAnswerContent'); // ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Claude
            const sourcesHeader = document.getElementById('sourcesHeader');
            const sourcesContainer = document.getElementById('sourcesContainer');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const loadingMessage = document.getElementById('loadingMessage');


            let db;
            let auth;
            let userId;
            let isAuthReady = false;

            // ØªÙ‡ÙŠØ¦Ø© Firebase Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
            // ØªÙ… ØªØ¶Ù…ÙŠÙ† firebaseConfig Ù…Ø¨Ø§Ø´Ø±Ø© Ù‡Ù†Ø§ Ù„ØªØ¬Ø§ÙˆØ² Ù…Ø´Ø§ÙƒÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
            const firebaseConfig = {
              apiKey: "AIzaSyC-gTQykWmRjGVYMp09VjGwSuVSB7Ai4UE",
              authDomain: "islamic-qa-web-app.firebaseapp.com",
              projectId: "islamic-qa-web-app",
              storageBucket: "islamic-qa-web-app.appspot.com",
              messagingSenderId: "491578843645",
              appId: "1:491578843645:web:9495241fce629cbe4e3994",
              measurementId: "G-GMEN1N432F"
            };

            const app = firebase.initializeApp(firebaseConfig); 
            db = firebase.firestore(); 
            auth = firebase.auth();   
            console.log("Firebase initialized."); 

            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØªØ­Ø¯ÙŠØ¯ userId
            firebase.auth().onAuthStateChanged(async (user) => { 
                console.log("onAuthStateChanged triggered."); 
                if (user) {
                    userId = user.uid;
                    console.log("Firebase authenticated. User ID:", userId);
                } else {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            const userCredential = await firebase.auth().signInWithCustomToken(__initial_auth_token); 
                            userId = userCredential.user.uid;
                            console.log("Signed in with custom token. User ID:", userId);
                        } catch (error) {
                            console.error("Error signing in with custom token:", error);
                            try {
                                const userCredential = await firebase.auth().signInAnonymously(); 
                                userId = userCredential.user.uid;
                                console.log("Signed in anonymously. User ID:", userId);
                            } catch (anonError) {
                                console.error("Error signing in anonymously:", anonError);
                                userId = crypto.randomUUID();
                                console.log("Using random User ID (fallback):", userId);
                            }
                        }
                    } else {
                        try {
                            const userCredential = await firebase.auth().signInAnonymously(); 
                            userId = userCredential.user.uid;
                            console.log("Signed in anonymously. User ID:", userId);
                        } catch (anonError) {
                            console.error("Error signing in anonymously:", anonError);
                            userId = crypto.randomUUID();
                            console.log("Using random User ID (fallback):", userId);
                        }
                    }
                }
                isAuthReady = true;
                console.log("isAuthReady set to true. Loading popular questions..."); 
                loadPopularQuestions(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
            });

            // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø© Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªÙˆØ³ÙŠØ¹/Ø§Ù„Ø·ÙŠ
            let retrievedSourcesData = [];

            // Ø¯Ø§Ù„Ø© Ù„ØªÙ…ÙŠÙŠØ² ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù†Øµ
            function highlightText(text, query) {
                if (!query || !text) return text;
                const queryWords = query.split(/\s+/).filter(word => word.length > 0);
                if (queryWords.length === 0) return text;

                const regex = new RegExp(queryWords.join('|'), 'gi');
                return text.replace(regex, (match) => `<span class="highlight">${match}</span>`);
            }

            // Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙÙŠ Firestore
            async function saveQuestionToFirestore(questionText) {
                if (!isAuthReady || !db || !userId) {
                    console.warn("Firebase not ready or User ID not available for saving question.");
                    return;
                }
                try {
                    // Log the appId being used for Firestore path
                    const appIdForFirestore = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    console.log("Firestore Path App ID (for saving):", appIdForFirestore);

                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… db.collection() Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† collection()
                    const questionsCollectionRef = db.collection(`artifacts/${appIdForFirestore}/public/data/asked_questions`);
                    await questionsCollectionRef.add({ // Ø§Ø³ØªØ®Ø¯Ø§Ù… add() Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† addDoc()
                        question: questionText,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(), // Ø§Ø³ØªØ®Ø¯Ø§Ù… serverTimestamp
                        userId: userId
                    });
                    console.log("Question saved to Firestore:", questionText);
                } catch (e) {
                    console.error("Error adding document to Firestore: ", e);
                }
            }

            // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ù…Ù† Firestore
            async function loadPopularQuestions() {
                if (!isAuthReady || !db) {
                    console.warn("Firebase not ready for loading questions.");
                    return;
                }
                popularQuestionsList.innerHTML = '<p class="text-center text-gray-500">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...</p>';
                try {
                    // Log the appId being used for Firestore path
                    const appIdForFirestore = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    console.log("Firestore Path App ID (for loading):", appIdForFirestore);

                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… db.collection() Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† collection()
                    const questionsCollectionRef = db.collection(`artifacts/${appIdForFirestore}/public/data/asked_questions`);
                    const q = questionsCollectionRef.orderBy("timestamp", "desc").limit(10); // Ø§Ø³ØªØ®Ø¯Ø§Ù… orderBy Ùˆ limit Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø¬Ø¹
                    const querySnapshot = await q.get(); // Ø§Ø³ØªØ®Ø¯Ø§Ù… get() Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† getDocs()

                    popularQuestionsList.innerHTML = ''; 
                    if (querySnapshot.empty) {
                        popularQuestionsList.innerHTML = '<p class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø³Ø§Ø¨Ù‚Ø©.</p>';
                    } else {
                        querySnapshot.forEach((doc) => {
                            const questionData = doc.data();
                            const listItem = document.createElement('li');
                            listItem.textContent = questionData.question;
                            listItem.title = `Ø³Ø¤Ø§Ù„ Ø·Ø±Ø­Ù‡: ${questionData.userId || 'Ù…Ø¬Ù‡ÙˆÙ„'}`; 
                            listItem.addEventListener('click', () => {
                                questionInput.value = questionData.question;
                                askButton.click(); 
                            });
                            popularQuestionsList.appendChild(listItem);
                        });
                    }
                } catch (e) {
                    console.error("Error loading popular questions from Firestore: ", e);
                    popularQuestionsList.innerHTML = '<p class="error-message">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©.</p>';
                }
            }

            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ askButton Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø­Ø¯Ø«
            if (askButton) {
                askButton.addEventListener('click', async () => {
                    console.log("Ask button click event listener triggered!"); 
                    const question = questionInput.value.trim();
                    const author = authorInput.value.trim();
                    
                    if (!question && !author) {
                        responseArea.classList.remove('hidden'); 
                        loadingMessage.classList.add('hidden'); 
                        geminiAnswerContent.innerHTML = '';
                        claudeAnswerContent.innerHTML = ''; // ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
                        sourcesHeader.classList.add('hidden');
                        sourcesContainer.innerHTML = '';
                        noResultsMessage.classList.add('hidden');
                        responseArea.innerHTML = '<p class="error-message">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¤Ø§Ù„ Ø£Ùˆ Ø§Ø³Ù… Ù…Ø¤Ù„Ù.</p>';
                        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø³Ø¤Ø§Ù„ Ø£Ùˆ Ù…Ø¤Ù„ÙØŒ Ø£Ø¹Ø¯ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
                        popularQuestionsSection.classList.remove('hidden'); 
                        return;
                    }

                    // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ø¹Ù†Ø¯ Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯
                    popularQuestionsSection.classList.add('hidden'); 
                    responseArea.classList.remove('hidden'); 

                    if (question) {
                        await saveQuestionToFirestore(question);
                    }

                    loadingMessage.classList.remove('hidden'); 
                    geminiAnswerContent.innerHTML = '';
                    claudeAnswerContent.innerHTML = ''; // ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
                    sourcesHeader.classList.add('hidden');
                    sourcesContainer.innerHTML = '';
                    noResultsMessage.classList.add('hidden');
                    
                    askButton.disabled = true;

                    let apiUrl = `https://islamic-qa-api-backend.onrender.com/ask?`;
                    const params = [];

                    if (question) {
                        params.push(`q=${encodeURIComponent(question)}`);
                    }
                    if (author) {
                        params.push(`author=${encodeURIComponent(author)}`);
                    }
                    apiUrl += params.join('&');

                    try {
                        const response = await fetch(apiUrl);
                        const data = await response.json();

                        loadingMessage.classList.add('hidden'); 

                        if (response.ok) {
                            if (data.gemini_answer) {
                                geminiAnswerContent.innerHTML = `<h2 class="text-xl font-semibold text-indigo-700 mb-2">Ø¥Ø¬Ø§Ø¨Ø© Gemini:</h2><p>${data.gemini_answer}</p>`;
                            } else {
                                geminiAnswerContent.innerHTML = '';
                            }

                            if (data.claude_answer) { // ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
                                claudeAnswerContent.innerHTML = `<h2 class="text-xl font-semibold text-indigo-700 mb-2">Ø¥Ø¬Ø§Ø¨Ø© Claude:</h2><p>${data.claude_answer}</p>`;
                            } else {
                                claudeAnswerContent.innerHTML = '';
                            }

                            retrievedSourcesData = data.sources_retrieved || [];
                            
                            if (retrievedSourcesData.length > 0) {
                                sourcesHeader.textContent = `Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø© (${retrievedSourcesData.length} Ù†ØªÙŠØ¬Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©):`;
                                sourcesHeader.classList.remove('hidden'); 

                                const groupedSources = new Map();
                                retrievedSourcesData.forEach(source => {
                                    const authorName = source.author_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                                    if (!groupedSources.has(authorName)) {
                                        groupedSources.set(authorName, []);
                                    }
                                    groupedSources.get(authorName).push(source);
                                });

                                let sourcesHtmlContent = ''; 
                                const initialSourcesPerAuthor = 3;

                                groupedSources.forEach((authorSources, authorName) => {
                                    const totalSourcesForAuthor = authorSources.length;
                                    const displaySources = authorSources.slice(0, initialSourcesPerAuthor);
                                    const hasMoreSources = totalSourcesForAuthor > initialSourcesPerAuthor;
                                    const authorIdClean = authorName.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '-');

                                    sourcesHtmlContent += `
                                        <div class="author-group" id="author-group-${authorIdClean}">
                                            <div class="author-group-header">
                                                Ø§Ù„Ù…Ø¤Ù„Ù: ${authorName} (${totalSourcesForAuthor} Ù†ØªÙŠØ¬Ø©)
                                            </div>
                                            <div class="author-sources-container" id="author-sources-container-${authorIdClean}">
                                    `;

                                    displaySources.forEach((source, sourceIndex) => {
                                        const fullText = source.text_content;
                                        const highlightedFullText = highlightText(fullText, question);
                                        const highlightedTruncatedText = highlightedFullText.substring(0, 250) + (highlightedFullText.length > 250 ? '...' : '');
                                        const needsTruncation = fullText.length > 250;

                                        sourcesHtmlContent += `
                                            <div class="source-item">
                                                <div class="source-header">${source.book_title}</div>
                                                <div class="source-meta">
                                                    Ø§Ù„Ø¬Ø²Ø¡: ${source.part_number}, Ø§Ù„ØµÙØ­Ø©: ${source.page_number}
                                                </div>
                                                <div id="source-text-${authorIdClean}-${sourceIndex}" class="source-text-truncated">
                                                    ${highlightedTruncatedText}
                                                </div>
                                                ${needsTruncation ? `<span class="toggle-text-button" data-author-id="${authorIdClean}" data-source-index="${sourceIndex}" data-expanded="false">Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ ÙƒØ§Ù…Ù„Ø§Ù‹</span>` : ''}
                                            </div>
                                        `;
                                    });

                                    if (hasMoreSources) {
                                        sourcesHtmlContent += `
                                            <button class="show-all-author-sources-button" data-author-id="${authorIdClean}" data-expanded="false">
                                                Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ù…Ø¤Ù„Ù (${totalSourcesForAuthor})
                                            </button>
                                        `;
                                    }
                                    sourcesHtmlContent += `
                                            </div>
                                        </div>
                                    `;
                                });
                                sourcesContainer.innerHTML = sourcesHtmlContent; 

                                document.querySelectorAll('.toggle-text-button[data-source-index]').forEach(button => {
                                    button.addEventListener('click', () => {
                                        const authorId = button.dataset.authorId;
                                        const sourceIndex = parseInt(button.dataset.sourceIndex);
                                        const textDiv = document.getElementById(`source-text-${authorId}-${sourceIndex}`);
                                        const isExpanded = button.dataset.expanded === 'true'; 

                                        const authorName = Array.from(groupedSources.keys()).find(key => key.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '-') === authorId);
                                        const originalSource = groupedSources.get(authorName)[sourceIndex];

                                        if (isExpanded) { 
                                            const highlightedTruncatedText = highlightText(originalSource.text_content, question).substring(0, 250) + '...';
                                            textDiv.innerHTML = highlightedTruncatedText; 
                                            button.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ ÙƒØ§Ù…Ù„Ø§Ù‹'; 
                                            button.dataset.expanded = 'false';
                                        } else {
                                            const highlightedFullText = highlightText(originalSource.text_content, question);
                                            textDiv.innerHTML = highlightedFullText; 
                                            button.textContent = 'Ø·ÙŠ Ø§Ù„Ù†Øµ'; 
                                            button.dataset.expanded = 'true';
                                        }
                                    });
                                });

                                document.querySelectorAll('.show-all-author-sources-button').forEach(button => {
                                    button.addEventListener('click', () => {
                                        const authorId = button.dataset.authorId;
                                        const authorSourcesContainer = document.getElementById(`author-sources-container-${authorId}`);
                                        const isExpanded = button.dataset.expanded === 'true';

                                        const authorName = Array.from(groupedSources.keys()).find(key => key.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '-') === authorId);
                                        const allAuthorSources = groupedSources.get(authorName);

                                        if (isExpanded) {
                                            let collapsedHtml = '';
                                            allAuthorSources.slice(0, initialSourcesPerAuthor).forEach((source, sourceIndex) => {
                                                const fullText = source.text_content;
                                                const highlightedFullText = highlightText(fullText, question);
                                                const truncatedText = highlightedFullText.substring(0, 250) + (highlightedFullText.length > 250 ? '...' : '');
                                                const needsTruncation = fullText.length > 250;
                                                collapsedHtml += `
                                                    <div class="source-item">
                                                        <div class="source-header">${source.book_title}</div>
                                                        <div class="source-meta">
                                                            Ø§Ù„Ø¬Ø²Ø¡: ${source.part_number}, Ø§Ù„ØµÙØ­Ø©: ${source.page_number}
                                                        </div>
                                                        <div id="source-text-${authorId}-${sourceIndex}" class="source-text-truncated">
                                                            ${truncatedText}
                                                        </div>
                                                        ${needsTruncation ? `<span class="toggle-text-button" data-author-id="${authorId}" data-source-index="${sourceIndex}" data-expanded="false">Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ ÙƒØ§Ù…Ù„Ø§Ù‹</span>` : ''}
                                                    </div>
                                                `;
                                            });
                                            authorSourcesContainer.innerHTML = collapsedHtml;
                                            button.textContent = `Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ù…Ø¤Ù„Ù (${totalSourcesForAuthor})`;
                                            button.dataset.expanded = 'false';
                                            addIndividualToggleListeners(authorId, groupedSources, question);

                                        } else {
                                            let expandedHtml = '';
                                            allAuthorSources.forEach((source, sourceIndex) => {
                                                const fullText = source.text_content;
                                                const highlightedFullText = highlightText(fullText, question);
                                                const truncatedText = highlightedFullText.substring(0, 250) + (highlightedFullText.length > 250 ? '...' : '');
                                                const needsTruncation = fullText.length > 250;
                                                expandedHtml += `
                                                    <div class="source-item">
                                                        <div class="source-header">${source.book_title}</div>
                                                        <div class="source-meta">
                                                            Ø§Ù„Ø¬Ø²Ø¡: ${source.part_number}, Ø§Ù„ØµÙØ­Ø©: ${source.page_number}
                                                        </div>
                                                        <div id="source-text-${authorId}-${sourceIndex}" class="source-text-truncated">
                                                            ${highlightedFullText}
                                                        </div>
                                                        ${needsTruncation ? `<span class="toggle-text-button" data-author-id="${authorId}" data-source-index="${sourceIndex}" data-expanded="true">Ø·ÙŠ Ø§Ù„Ù†Øµ</span>` : ''}
                                                    </div>
                                                `;
                                            });
                                            authorSourcesContainer.innerHTML = expandedHtml;
                                            button.textContent = 'Ø·ÙŠ ÙƒÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ù…Ø¤Ù„Ù';
                                            button.dataset.expanded = 'true';
                                            addIndividualToggleListeners(authorId, groupedSources, question);
                                        }
                                    });
                                });

                                function addIndividualToggleListeners(currentAuthorId, currentGroupedSources, currentQuestion) {
                                    document.querySelectorAll(`.toggle-text-button[data-author-id="${currentAuthorId}"]`).forEach(btnElement => { 
                                        btnElement.addEventListener('click', () => {
                                            const idx = parseInt(btnElement.dataset.sourceIndex);
                                            const txtDivElement = document.getElementById(`source-text-${currentAuthorId}-${idx}`); 
                                            const isExpandedLocal = btnElement.dataset.expanded === 'true'; 
                                            
                                            const authName = Array.from(currentGroupedSources.keys()).find(key => key.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '-') === currentAuthorId);
                                            const originalSource = currentGroupedSources.get(authName)[idx];

                                            if (isExpandedLocal) { 
                                                const highlightedTruncatedText = highlightText(originalSource.text_content, currentQuestion).substring(0, 250) + '...';
                                                txtDivElement.innerHTML = highlightedTruncatedText; 
                                                btnElement.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ ÙƒØ§Ù…Ù„Ø§Ù‹'; 
                                                btnElement.dataset.expanded = 'false';
                                            } else {
                                                const highlightedFullText = highlightText(originalSource.text_content, currentQuestion);
                                                txtDivElement.innerHTML = highlightedFullText; 
                                                btnElement.textContent = 'Ø·ÙŠ Ø§Ù„Ù†Øµ'; 
                                                btnElement.dataset.expanded = 'true';
                                            }
                                        });
                                    });
                                }

                            } else {
                                sourcesHeader.classList.add('hidden');
                                sourcesContainer.innerHTML = '';
                                noResultsMessage.classList.remove('hidden');
                                if (!data.gemini_answer && !data.claude_answer) { // ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
                                    noResultsMessage.textContent = 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£Ø¬Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø°Ø§Øª ØµÙ„Ø© ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø©.';
                                    noResultsMessage.classList.remove('hidden');
                                }
                            }
                        } else {
                            geminiAnswerContent.innerHTML = '';
                            claudeAnswerContent.innerHTML = ''; // ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
                            sourcesHeader.classList.add('hidden');
                            sourcesContainer.innerHTML = '';
                            noResultsMessage.classList.add('hidden');
                            responseArea.innerHTML = `<p class="error-message">Ø®Ø·Ø£: ${data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.'}</p>`;
                        }
                    } catch (error) {
                        console.error('Error fetching data:', error); 
                        geminiAnswerContent.innerHTML = '';
                        claudeAnswerContent.innerHTML = ''; // ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
                        sourcesHeader.classList.add('hidden');
                        sourcesContainer.innerHTML = '';
                        noResultsMessage.classList.add('hidden');
                        responseArea.innerHTML = `<p class="error-message">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>`;
                    } finally {
                        askButton.disabled = false;
                        loadPopularQuestions();
                    }
                });
            } else {
                console.error("Error: askButton element not found! Script might be running before DOM is ready or ID is incorrect."); 
            }
            console.log("Script finished DOMContentLoaded execution."); 
        }); // Ù†Ù‡Ø§ÙŠØ© DOMContentLoaded
        console.log("Script loaded."); 
    </script>
</body>
</html>
